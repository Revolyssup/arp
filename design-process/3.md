# Service Discovery related changes

- Single EventBus will be used for all service discoverers with each discoverer publishing nodes on the topic by it's name.

# EventBus changes

The previous implementation of EventBus had a problem. The eventbus is stateless which I thought won't be an issue and for the most part it isn't except when data is Published on a topic before subscribers come up. Currently the eventbus doesn't store data and just sends it to all subscribers. In the aforementioned case, there will be data loss as the publisher will have no subscriber to send data to and will just discard the data. Currently Listeners(subscribers) and ConfigWatcher(Publisher) both are static and we control that subscribers are set up before data is published but we won't be able to guarantee this while using the EventBus for service discovery where Subscribers are dynamically created upstreams which come and go.

## Solution: Caching last used data

I think the EventBus can still be used by storing the last data for each topic. This should be good enough for usage in a reverse proxy where at most places (ConfigWatcher->Listener/ Discoverer -> DynamicUpstream), we only care about the latest configuration. So the behaviour can be modify like following:

1. When a subscriber is added for a topic, by default it gets the data stored in the cache.

2. Cache will contain map[topic]LastData.

3. Publisher will reset the cache before publishing data to existing subscribers.

4. EventBus will also have Unsubscribe method so that dynamic subscribers don't leak channels as they go.
