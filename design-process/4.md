# Refactoring

- The initial implemenation had few components mixed up inside Listener and it wasn't easy to test them independently. So in this refactor, components have been cleanly separated out and unit tests have been added for them.

- Maybe converting every app into a CLI isn't that great of an idea and seems like unnecessary bloat addition, I'm still going ahead and using cobra CLI that will create an ARP instance for the sake of being idiomatic I guess :)

- Proper routine handling via waitgroups and context cancellation was intentionally ignored initially and is being added now.

## Adding logging

- I am not using slog or any structured logging for now. For now, it will just be

```bash
LOGLEVEL [component] log
```

where component is list of components that triggered the log like:

```bash
DEBU [arp->watcher->file_provider]: file provider watching: /home/ashish/dev/arp/dynamic.yaml
```

Maybe not the best way but still useful for debugging. In case a component is reused by multiple parent component, I can use a call hierarchy to find exact logs.

Example:

```bash

    █████╗ ██████╗ ██████╗
   ██╔══██╗██╔══██╗██╔══██╗
   ███████║██████╔╝██████╔╝
   ██╔══██║██╔══██╗██╔═══╝
   ██║  ██║██║  ██║██║
   ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝

 Another Reverse Proxy
         starting...

INFO [arp->discovery_manager]: Starting discovery with config: {demo map[interval:10s]}
INFO [arp->demo_discovery]: Starting demo discovery with config: map[interval:10s]
INFO [arp]: ARP server started successfully with 1 listeners
INFO [arp]: Starting listener: http
DEBU [arp->demo_discovery]: Publishing nodes for demo discovery: &{ http://httpbin.org/headers} for name demo
WARN [arp->watcher->file_provider]: file provider sent updated configuration
DEBU [arp->watcher->file_provider]: file provider watching: /home/ashish/dev/arp/dynamic.yaml
INFO [arp->listener_processor]: Published updated config for listener: http
INFO [arp->listener_http]: Updating routes for listener http
WARN [arp->discovery_manager]: discoverers &{map[demo:0xc0000102b8] 0xc0000c3e90 0xc000010228}
INFO [arp->listener_http->router]: Adding plugin demo2 to route route1
INFO [arp->listener_http->router]: Adding plugin demo to route route2
^CINFO [arp]: Received signal: interrupt
INFO [arp]: Initiating graceful shutdown...
WARN [arp->watcher->watcher]: Watcher received shutdown signal
INFO [arp]: Stopping listener: http
INFO [arp]: Configuration watcher stopped
INFO [arp]: Listener http stopped
INFO [arp]: Shutdown completed successfully

```
